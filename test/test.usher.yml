
vars:
  registry: docker-registry.dun.fh
  image: findmypast/usher

tasks:
  build:
    - cmd: docker build --force-rm -t <%=registry%>/<%=image%>:<%=version%> .

  publish:
    - cmd: docker run --name usher-publisher --rm <%=registry%>/<%=image%>:<%=version%> npm run publish-to-npm
      environment:
        - NPM_USER=<%=user%>
        - NPM_PASSWORD=<%=password%>
        - NPM_EMAIL=<%=email%>

  build_seq:
    - cmd: docker rm -f <%=image%>-local
    - cmd: docker build --force-rm -t <%=registry%>/<%=image%>:<%=version%> .

  build_seq_ignore_errors:
    - cmd: docker rm -f <%=image%>-local
      ignore_errors: true
    - cmd: docker build --force-rm -t <%=registry%>/<%=image%>:<%=version%> .
